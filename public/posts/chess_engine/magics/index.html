<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="UTF-8" />
        <title>Move Generation: Magic Bitboards</title>

        
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
        <meta name="description" content="Exploring Magic Bitboards, how they function, what they solve, and generating moves for sliding pieces &#43; packaging it all into a handy crate for everyone.">
        <meta name="author" content="Swoyam Pokharel" />
        <meta name="keywords" content="blog, dev, swoyam, hugo, minimal" />

        
        <meta property="og:title" content="Move Generation: Magic Bitboards">
        <meta property="og:description" content="Exploring Magic Bitboards, how they function, what they solve, and generating moves for sliding pieces &#43; packaging it all into a handy crate for everyone.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="http://localhost:1313/posts/chess_engine/magics/">
        
        <meta property="og:image" content="http://localhost:1313/images/preview.png">

        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Move Generation: Magic Bitboards">
        <meta name="twitter:description" content="Exploring Magic Bitboards, how they function, what they solve, and generating moves for sliding pieces &#43; packaging it all into a handy crate for everyone.">

        
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />

        
        <link rel="stylesheet" href="/css/output.css">
    </head>
    <body class="w-screen text-white">
        <header class="flex justify-between items-center p-8">
            <a class="uppercase font-bold text-xl tracking-widest" href="/">(._.)</a>
            <nav class="flex gap-6 text-sm underline uppercase tracking-wide"
                 >
                 <a
                         href="https://github.com/PS-Wizard"
                         target="_blank"
                         rel="noopener"
                         class="hover:underline"
                         >
                         GITHUB
                 </a>
                     <a
                             href="https://www.linkedin.com/in/swoyam-pokharel-557779340/"
                             target="_blank"
                             rel="noopener"
                             class="hover:underline"
                             >
                             LINKEDIN
                     </a>
            </nav>
        </header>

        <div class="min-h-screen main-content w-full pb-16 text-white ">
            


<div class="fixed bottom-6 right-6 z-50">
  <details class="group relative">
    <summary class="bg-white text-black px-5 py-3 rounded-full shadow-lg cursor-pointer text-sm font-semibold transition hover:bg-neutral-100">
      Table of Contents
    </summary>
    <div class="absolute bottom-14 right-0 w-[90vw] md:w-[28rem] max-h-[32rem] overflow-y-auto bg-neutral-900 text-white border border-[#252525] rounded-xl shadow-2xl p-6 mt-3 prose prose-invert text-sm leading-relaxed ">
      <h2 class="font-bold mb-4">Jump to section</h2>
      <nav class="[&_ul]:pl-4 [&_ul]:list-disc [&_li]:ml-1 [&_a]:no-underline [&_a:hover]:underline">
          <nav id="TableOfContents">
  <ul>
    <li><a href="#magic-bitboards">Magic Bitboards</a>
      <ul>
        <li><a href="#the-basic-approach">The Basic Approach</a></li>
        <li><a href="#the-bottleneck">The Bottleneck</a></li>
        <li><a href="#the-key-insight">The Key Insight</a></li>
        <li><a href="#building-the-magic">Building the Magic</a>
          <ul>
            <li><a href="#generating-blocker-configurations">Generating Blocker Configurations</a></li>
            <li><a href="#generating-the-mask">Generating the Mask</a></li>
            <li><a href="#generating-attack-maps">Generating Attack Maps</a></li>
          </ul>
        </li>
        <li><a href="#the-actual-magic">The Actual Magic</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </nav>
    </div>
  </details>
</div>

<div class="w-full flex justify-center items-center p-4 my-8 flex-col">
    <div class="w-full max-w-7xl pb-4 flex flex-col md:flex-row justify-between items-center">
        <nav class="text-sm text-neutral-400 mb-4">
            <a href="/posts" class="hover:underline">Posts</a>
            
            / <a href="/posts/chess_engine/" class="hover:underline">Chess Engine</a>
            
            / <span class="text-white">Move Generation: Magic Bitboards</span>
        </nav>
        
        <a href="https://github.com/PS-Wizard/EvalDeez/tree/main/crates/magician" class="hidden md:block text-sm hover:underline" target="_blank" rel="noopener">
            View In Github &rarr;
        </a>
        
    </div>
<img src="/images/default_blogs.jpg" alt="Card image" class="max-w-7xl h-69 object-cover rounded-xl" />
</div>
<div class="relative max-w-7xl mx-auto px-4 flex flex-col">
    
    <main class="prose prose-invert max-w-7xl flex-grow break-words">
        <h1 id="magic-bitboards">Magic Bitboards</h1>
<p>Magic Bitboards are a go-to technique in modern bitboard engines for generating moves for sliding pieces. They’re used in top-tier engines like <a href="https://www.chessprogramming.org/Stockfish">Stockfish</a>, <a href="https://www.chessprogramming.org/Crafty">Crafty</a>, and <a href="https://www.chessprogramming.org/Arasan">Arasan</a>, and are widely regarded as one of the fastest ways to generate legal moves.</p>
<p>This post aims to break down the concept of Magic Bitboards—what they are, how they work, and why they&rsquo;re worth the effort. I’m still getting my feet wet with this stuff myself, so I’ll explain it in a way that hopefully clicks for anyone just diving in.</p>
<hr>
<h2 id="the-basic-approach">The Basic Approach</h2>
<p>Let’s begin with how move generation typically works for sliding pieces.</p>
<p>For sliding pieces like rooks and bishops, the first instinct is to generate moves using a loop in the piece’s movement directions until a blocking piece is encountered. For rooks, these directions are <code>[8, -8, 1, -1]</code>. For bishops, <code>[9, 7, -9, -7]</code>. These numbers correspond to bitboard offsets.</p>
<p><img src="/images/chess_engine/chess_board.png" alt="Chess Board"></p>
<p>Here&rsquo;s how a bishop on <code>e4</code> (index <code>28</code>) would move:</p>
<ul>
<li><code>d5</code> (index 35): offset <code>+7</code></li>
<li><code>f5</code> (index 37): offset <code>+9</code></li>
<li><code>d3</code> (index 19): offset <code>-9</code></li>
<li><code>f3</code> (index 21): offset <code>-7</code></li>
</ul>
<p>Any additional reachable squares like <code>c6</code> are just further steps in those directions. This pattern holds no matter the starting square—until a piece blocks the path.</p>
<p><img src="/images/chess_engine/bishop_offests.png" alt="Bishop Offsets"></p>
<p>So, in a simple loop, we step along each of the 4 diagonal directions for a bishop (or 4 orthogonal ones for a rook) and stop when blocked. That’s your basic sliding move generation.</p>
<div class="my-2 p-4 border border-green-500/30 bg-green-500/10 rounded-lg text-green-200">
  <div class="flex items-start gap-3">
    <svg class="w-5 h-5 mt-1 text-green-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 1 1-10 10A10 10 0 0 1 12 2z"/>
    </svg>
    <strong class="underline">Note About Queens</strong>
  </div>
  We don&rsquo;t generate queen moves separately. A queen&rsquo;s movement is just the union of a bishop’s and a rook’s moves.
</div>

<hr>
<h2 id="the-bottleneck">The Bottleneck</h2>
<p>While looping works fine for a human player or a simple one-off calculation, it becomes inefficient when generating millions of moves per second during deep search trees. That’s where this approach falls short. It simply isn’t fast enough.</p>
<p>So how do we make it fast?</p>
<blockquote>
<p>When in doubt, use a hash map. If you&rsquo;re still in doubt, use two.</p></blockquote>
<p>Let’s say we try using a hash map. We make the key the bitboard representing all occupied squares, and the value the attack bitboard. Conceptually great. But practically?</p>
<p>64 bits means <code>2^64</code> possible combinations.</p>
<p>That’s about <code>1.8e+19</code> entries. Not feasible at all.</p>
<hr>
<h2 id="the-key-insight">The Key Insight</h2>
<p>We don’t need to consider the whole board. A sliding piece is only influenced by the blockers <em>along its movement rays</em>—not the entire board state.</p>
<p>This reduces the number of relevant bits to 13 or 14 per square:</p>
<ul>
<li>Bishop: 13 potential blocker squares -&gt; <code>2^13 = 8192</code> possibilities</li>
<li>Rook: 14 -&gt; <code>2^14 = 16384</code></li>
</ul>



<details  class="group w-full border-y border-white/20 overflow-hidden transition-all duration-200">
  <summary class="cursor-pointer list-none px-4 py-3 bg-none flex justify-between items-center">
    <span class="text-white h-full">
      <span class="underline text-sm">Why 13 and 14 blocker squares?</span>
    </span>
    <span class="transform transition-transform duration-200 group-open:rotate-180 text-white">
      
        <span>+</span>
      
    </span>
  </summary>
  <div class="px-4 py-3 text-sm text-white/80 bg-white/5">
    Each square a piece can move to lies along a ray. For central squares, bishops have 13 such squares along diagonals, rooks have 14 along ranks and files. Each square can either be empty or blocked, so we get <code>2^n</code> blocker configurations.
  </div>
</details>

<p>That’s way more manageable.</p>
<hr>
<h2 id="building-the-magic">Building the Magic</h2>
<p>To use Magic Bitboards, we need:</p>
<ul>
<li>A function to enumerate all blocker configurations</li>
<li>A function to generate attack maps for each configuration</li>
</ul>
<h3 id="generating-blocker-configurations">Generating Blocker Configurations</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">enumerate_blocker_configs</span>(mask: <span style="color:#66d9ef">u64</span>) -&gt; Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u64</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> relevant_bits <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">64</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (mask <span style="color:#f92672">&gt;&gt;</span> i) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>            relevant_bits.push(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> num_bits <span style="color:#f92672">=</span> relevant_bits.len();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> num_configs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> num_bits;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> configs <span style="color:#f92672">=</span> Vec::with_capacity(num_configs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>num_configs {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> blocker <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>num_bits {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;&gt;</span> j) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>                blocker <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> relevant_bits[j];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        configs.push(blocker);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    configs
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function takes a mask (of relevant squares) and spits out every possible blocker configuration using binary counting.</p>
<h3 id="generating-the-mask">Generating the Mask</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">rook_occupancy_mask</span>(square: <span style="color:#66d9ef">u8</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> rank <span style="color:#f92672">=</span> square <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> file <span style="color:#f92672">=</span> square <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> r <span style="color:#66d9ef">in</span> (rank <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..</span><span style="color:#ae81ff">7</span> {
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> (r <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> file);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> r <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>rank).rev() {
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> (r <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> file);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span> (file <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..</span><span style="color:#ae81ff">7</span> {
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> (rank <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>file).rev() {
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> (rank <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mask
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bishop_occupancy_mask</span>(square: <span style="color:#66d9ef">u8</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> rank <span style="color:#f92672">=</span> square <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> file <span style="color:#f92672">=</span> square <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (dr, df) <span style="color:#66d9ef">in</span> [(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)] {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> r <span style="color:#f92672">=</span> rank <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i8</span> <span style="color:#f92672">+</span> dr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> f <span style="color:#f92672">=</span> file <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i8</span> <span style="color:#f92672">+</span> df;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span><span style="color:#ae81ff">7</span>).contains(<span style="color:#f92672">&amp;</span>r) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span><span style="color:#ae81ff">7</span>).contains(<span style="color:#f92672">&amp;</span>f) {
</span></span><span style="display:flex;"><span>            mask <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> (r <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>);
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">+=</span> dr;
</span></span><span style="display:flex;"><span>            f <span style="color:#f92672">+=</span> df;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mask
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h3 id="generating-attack-maps">Generating Attack Maps</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">rook_attacks_from</span>(square: <span style="color:#66d9ef">u8</span>, blockers: <span style="color:#66d9ef">u64</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> rank <span style="color:#f92672">=</span> square <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> file <span style="color:#f92672">=</span> square <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> attacks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> r <span style="color:#66d9ef">in</span> (rank <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..</span><span style="color:#ae81ff">8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sq <span style="color:#f92672">=</span> r <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> file;
</span></span><span style="display:flex;"><span>        attacks <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> sq;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (blockers <span style="color:#f92672">&gt;&gt;</span> sq) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> { <span style="color:#66d9ef">break</span>; }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> r <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>rank).rev() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sq <span style="color:#f92672">=</span> r <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> file;
</span></span><span style="display:flex;"><span>        attacks <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> sq;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (blockers <span style="color:#f92672">&gt;&gt;</span> sq) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> { <span style="color:#66d9ef">break</span>; }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span> (file <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..</span><span style="color:#ae81ff">8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sq <span style="color:#f92672">=</span> rank <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f;
</span></span><span style="display:flex;"><span>        attacks <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> sq;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (blockers <span style="color:#f92672">&gt;&gt;</span> sq) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> { <span style="color:#66d9ef">break</span>; }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>file).rev() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sq <span style="color:#f92672">=</span> rank <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f;
</span></span><span style="display:flex;"><span>        attacks <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> sq;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (blockers <span style="color:#f92672">&gt;&gt;</span> sq) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> { <span style="color:#66d9ef">break</span>; }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    attacks
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bishop_attacks_from</span>(square: <span style="color:#66d9ef">u8</span>, blockers: <span style="color:#66d9ef">u64</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> rank <span style="color:#f92672">=</span> square <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> file <span style="color:#f92672">=</span> square <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> attacks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (dr, df) <span style="color:#66d9ef">in</span> [(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)] {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> r <span style="color:#f92672">=</span> rank <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i8</span> <span style="color:#f92672">+</span> dr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> f <span style="color:#f92672">=</span> file <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i8</span> <span style="color:#f92672">+</span> df;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">8</span>).contains(<span style="color:#f92672">&amp;</span>r) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">8</span>).contains(<span style="color:#f92672">&amp;</span>f) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> idx <span style="color:#f92672">=</span> r <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> f <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u8</span>;
</span></span><span style="display:flex;"><span>            attacks <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> idx;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> blockers <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">1</span><span style="color:#66d9ef">u64</span> <span style="color:#f92672">&lt;&lt;</span> idx) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> { <span style="color:#66d9ef">break</span>; }
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">+=</span> dr;
</span></span><span style="display:flex;"><span>            f <span style="color:#f92672">+=</span> df;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    attacks
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="the-actual-magic">The Actual Magic</h2>
<p>Now that we have all blocker configurations and attack maps, we want a way to map each blocker config to a unique index into an array of precomputed attack maps. That’s where the magic number comes in.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">generate_sparse_u64</span>(min_bits: <span style="color:#66d9ef">u32</span>, max_bits: <span style="color:#66d9ef">u32</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> rng <span style="color:#f92672">=</span> rand::rng();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> num_bits <span style="color:#f92672">=</span> rng.random_range(min_bits<span style="color:#f92672">..=</span>max_bits);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> candidate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> set_bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> set_bits <span style="color:#f92672">&lt;</span> num_bits {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> bit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rng.random_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">64</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> candidate <span style="color:#f92672">&amp;</span> bit <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            candidate <span style="color:#f92672">|=</span> bit;
</span></span><span style="display:flex;"><span>            set_bits <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    candidate
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">find_magics_number</span>(square: <span style="color:#66d9ef">u8</span>, mask: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">u64</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> relevant_bits <span style="color:#f92672">=</span> mask.count_ones();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> blocker_configs <span style="color:#f92672">=</span> enumerate_blocker_configs(<span style="color:#f92672">*</span>mask);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> shift <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">-</span> relevant_bits;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> table_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> relevant_bits;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> index_mask <span style="color:#f92672">=</span> table_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">&#39;search</span>: <span style="color:#a6e22e">for</span> _ <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">1_000_000</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> magic_candidate <span style="color:#f92672">=</span> generate_sparse_u64(<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> used_indices <span style="color:#f92672">=</span> <span style="color:#a6e22e">vec!</span>[<span style="color:#66d9ef">false</span>; table_size];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">&amp;</span>blockers <span style="color:#66d9ef">in</span> <span style="color:#f92672">&amp;</span>blocker_configs {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> (blockers.wrapping_mul(magic_candidate) <span style="color:#f92672">&gt;&gt;</span> shift) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">usize</span> <span style="color:#f92672">&amp;</span> index_mask;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> used_indices[index] {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span> &#39;search;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            used_indices[index] <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> magic_candidate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic!</span>(<span style="color:#e6db74">&#34;No magic number found for square </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, square);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This brute-forces random sparse <code>u64</code> values until we find one that produces a perfect hash for all blocker configs.</p>
<hr>
<p>And that&rsquo;s it. That&rsquo;s the core of how Magic Bitboards work. The rest is wiring it all together—writing to disk, loading the tables, etc.—which you can find in the full implementation <a href="https://github.com/PS-Wizard/EvalDeez/tree/main/crates/magician">here</a>.</p>
<p>Hope this helped clarify what the magic is all about.</p>

    </main>
    
</div>
<div class="w-full flex justify-center mt-12 border-t border-white/10 pt-6 text-sm text-white gap-2 flex-wrap">
    
    <a href="/posts/chess_engine/initial_setup/" rel="prev" class="hover:underline px-3 py-2 bg-white text-black font-bold rounded-md text-xs sm:text-sm">
        ← Initial setup &amp; Board Representation
    </a>
    

    
    <a href="/posts/chess_engine/nnue_theory/" rel="next" class="hover:underline px-3 py-2 bg-white text-black font-bold rounded-md text-xs sm:text-sm">
        NNUE Theory →
    </a>
    
</div>

        </div>
        <div class="w-full flex items-center bg-[#A3D5FF] h-[30vh] text-black px-10" >
            <div class="lg:w-1/2 h-full geist flex flex-col justify-end"> <h5
                 class="hidden lg:block text-48-126 font-semibold cursor-pointer"
                 bind:this={name_footer}
                 >
                 Wizard.
                </h5>
            </div>
            <div class="w-full lg:w-1/2 h-full geist flex flex-row justify-center gap-4" >
                <div class="flex flex-col h-full w-full justify-center items-center lg:items-end gap-4" >
                    <div class="flex gap-2">
                        <a
                                href="https://www.linkedin.com/in/swoyam-pokharel-557779340/"
                                target="_blank"
                                rel="noopener"
                                class="bg-black text-white w-fit text-16-32 px-4 py-2 rounded-lg hover:opacity-80 transition"
                                >
                                Linkedin
                        </a>
                            <a
                                    href="https://github.com/PS-Wizard"
                                    target="_blank"
                                    rel="noopener"
                                    class="bg-black text-white w-fit text-16-32 px-4 py-2 rounded-lg hover:opacity-80 transition"
                                    >
                                    Github
                            </a>
                                <a
                                        href="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                                        target="_blank"
                                        rel="noopener"
                                        class="hidden md:block bg-black text-white w-fit text-16-32 px-4 py-2 rounded-lg hover:opacity-80 transition"
                                        >
                                        Hopefully More lol
                                </a>
                    </div>
                    <div class="flex gap-2">
                        <a
                                href="https://pswoyam.com.np/"
                                target="_blank"
                                rel="noopener"
                                class="bg-black text-white w-fit text-16-32 px-4 py-2 rounded-lg hover:opacity-80 transition"
                                >
                                Portfolio
                        </a>
                            <a
                                    href="mailto:p.swoyam.1@gmail.com"
                                    target="_blank"
                                    rel="noopener"
                                    class="bg-black text-white w-fit text-16-32 px-4 py-2 rounded-lg hover:opacity-80 transition"
                                    >
                                    me@pswoyam.com.np
                            </a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

